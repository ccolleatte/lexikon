name: Security Scanning

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  pull_request:
    branches: [develop, master]
  push:
    branches: [develop]
  workflow_dispatch:

jobs:
  semgrep-sast:
    name: Semgrep SAST Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/owasp-top-ten
            p/typescript
            p/nodejs
            p/python
          generateSarif: true
          sarif-output: semgrep-report.sarif

      - name: Upload SARIF report
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: semgrep-report.sarif
          wait-for-processing: true

      - name: Comment PR with Semgrep results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('semgrep-report.sarif')) {
              const report = JSON.parse(fs.readFileSync('semgrep-report.sarif', 'utf8'));
              const results = report.runs[0].results || [];

              if (results.length > 0) {
                const criticalCount = results.filter(r => r.level === 'error').length;
                const warningCount = results.filter(r => r.level === 'warning').length;

                let comment = `## ğŸ”’ Semgrep Security Scan Results\n\n`;
                comment += `- âŒ **Critical Issues:** ${criticalCount}\n`;
                comment += `- âš ï¸ **Warnings:** ${warningCount}\n\n`;
                comment += `**Results available in [Security tab](../../security/code-scanning)**`;

                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            }

      - name: Fail on critical findings
        if: always()
        run: |
          if [ -f semgrep-report.sarif ]; then
            CRITICAL_COUNT=$(jq '[.runs[0].results[] | select(.level == "error")] | length' semgrep-report.sarif)
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "âŒ Found $CRITICAL_COUNT critical security issues"
              exit 1
            fi
          fi

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: high

  npm-audit:
    name: NPM Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: npm-audit
        run: |
          npm audit --audit-level=high 2>&1 | tee npm-audit.log || true

      - name: Parse npm audit results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const auditLog = fs.readFileSync('npm-audit.log', 'utf8');

            if (auditLog.includes('found') && (auditLog.includes('high') || auditLog.includes('critical'))) {
              const lines = auditLog.split('\n');
              let vulnInfo = '';
              for (const line of lines) {
                if (line.includes('found') || line.includes('audit')) {
                  vulnInfo = line;
                  break;
                }
              }

              const comment = `## ğŸš¨ NPM Audit Results\n\n${vulnInfo}\n\nRun \`npm audit\` locally to fix vulnerabilities.`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Fail on high severity
        run: |
          if grep -q "high" npm-audit.log; then
            echo "âŒ Found high severity vulnerabilities"
            exit 1
          fi

  pip-audit:
    name: Pip Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: Install pip-audit
        run: pip install pip-audit>=2.6.0

      - name: Run pip-audit
        id: pip-audit
        working-directory: backend
        run: |
          pip-audit --vulnerability-service osv 2>&1 | tee pip-audit.log || true

      - name: Parse pip audit results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const auditLog = fs.readFileSync('backend/pip-audit.log', 'utf8');

            if (auditLog.includes('vulnerability') || auditLog.includes('affected')) {
              const lines = auditLog.split('\n').slice(0, 15);
              const comment = `## ğŸš¨ Pip Audit Results\n\n\`\`\`\n${lines.join('\n')}\n\`\`\`\n\nRun \`pip-audit\` in backend/ to fix vulnerabilities.`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Fail on vulnerabilities
        working-directory: backend
        run: |
          if grep -q "vulnerability" pip-audit.log; then
            echo "âŒ Found Python package vulnerabilities"
            exit 1
          fi
